name: Deploy to Firebase Preview

on:
  pull_request:
    branches:
      - main

jobs:
  build_and_preview:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install root dependencies
        run: npm ci --ignore-scripts || npm install --ignore-scripts

      - name: Install functions dependencies
        working-directory: ./functions
        run: npm ci || npm install

      - name: Create environment config for Cloud Functions
        working-directory: ./functions
        run: |
          cat > .env.yaml << EOF
          ODDS_API_KEY: "${{ secrets.ODDS_API_KEY }}"
          EOF

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@13.0.0

      - name: Deploy Cloud Functions
        run: |
          echo "üîß Deploying Cloud Functions..."
          firebase deploy --only functions --project fpl-tool-dfb38 --token ${{ secrets.FIREBASE_TOKEN }} --non-interactive

      - name: Deploy to Firebase Preview Channel
        run: |
          set -o pipefail
          CHANNEL_ID="pr-${{ github.event.pull_request.number }}"

          echo "üöÄ Deploying to Firebase preview channel..."
          echo "Project ID: fpl-tool-dfb38"
          echo "Channel ID: $CHANNEL_ID"

          # Deploy and capture output
          if firebase hosting:channel:deploy $CHANNEL_ID \
            --expires 7d \
            --project fpl-tool-dfb38 \
            --token ${{ secrets.FIREBASE_TOKEN }} \
            --json 2>&1 | tee deploy-output.json; then
            
            # Extract the preview URL from the JSON response
            PREVIEW_URL=$(cat deploy-output.json | jq -r '.result | to_entries[0].value.url' 2>/dev/null || echo "")
            
            if [ -z "$PREVIEW_URL" ]; then
              echo "‚ö†Ô∏è Could not extract URL from response, trying alternative method..."
              PREVIEW_URL=$(cat deploy-output.json | grep -oP 'https://[^"]+\.web\.app' | head -1)
            fi
            
            if [ -n "$PREVIEW_URL" ]; then
              echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_ENV
              echo "‚úÖ Preview URL: $PREVIEW_URL"
            else
              echo "::warning::Deployment succeeded but could not extract preview URL"
              cat deploy-output.json
            fi
          else
            echo "::error::Firebase hosting deploy failed"
            echo "Error output:"
            cat deploy-output.json
            exit 1
          fi

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const previewUrl = process.env.PREVIEW_URL;
            if (previewUrl) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚úÖ Preview deployment succeeded!\n\nüîó **Preview URL:** ${previewUrl}\n\n*Preview expires in 7 days*`
              });
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚ùå Preview deployment failed. Check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`
              });
            }
